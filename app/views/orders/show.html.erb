<audio preload="auto" autobuffer id="player">
  <source src="/audios/notify.aac" />
  <source src="/audios/notify.ogg" />
  <p>Not Supported</p>
</audio>

<article class="row main">
  <div class="order-detail" style="margin-bottom: 20px;">

    <% unless @order.canceled? %>
    <ul class="order-progress">
      <li class="active">
        <i class="glyphicon glyphicon-list-alt"></i>
        <title>订单提交</title>
      </li>
      <li class="active">
        <hr>
      </li>
      <li class="<%=(@order.paid? || @order.printed? || @order.reviewed?) ? 'active' : ''%>">
        <i class="glyphicon glyphicon-yen"></i>
        <title>付款</title>
      </li>
      <li class="<%=(@order.paid? || @order.printed? || @order.reviewed?) ? 'active' : ''%>">
        <hr>
      </li>
      <li class="<%=((@order.printed? && params[:type].nil?) || @order.reviewed?) ? 'active' : ''%>">
        <i class="glyphicon glyphicon-fire"></i>
        <title>制作中</title>
      </li>
    </ul>
    <% if @order.printed? && !params[:type].nil? %>
    <div class="progress" id="progress-bar">
      <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
      </div>
    </div>
    <% end %>
    <% end %>

    <section>
      <h2 class="pull-left inherit-height table-center-wrap" style="font-size: 20px;margin-top: 0;margin-bottom: 4px;">
        <span class="table-center">
          <% if @order.printed? %>
            单号：<%= @order.simple_order_no %>
        <% else %>
          <%= @order.name %>
        <% end %>
        </span>
      </h2>
      <% if need_online_pay? @order %>
        <a class="btn btn-primary pull-right" target="_self" href="<%=@url%>">立即支付</a>
      <% end %>
      <% if @order.printed? %>
      <a class="btn btn-primary pull-right" target="_self" href="/orders/<%=@order.id%>/reviews">评价</a>
      <% end %>
    </section>
    <section>
      <h3>商品</h3>
      <table class="table" style="max-width: 600px">
        <thead>
          <tr>
            <th>数量</th><th>项目</th><th class="number-align">单价</th>
          </tr>
        </thead>
        <tbody>
          <% @order.orders_products.each do |orders_products| %>
            <tr>
              <td><%= orders_products.count %></td>
              <td>
                  <%= orders_products.product.name %> <%= orders_products.specification.value if orders_products.specification.present?%>
              </td>
              <td class="number-align"><%= number_to_currency orders_products.count*orders_products.price, locale: :'zh-CN', precision: 2 %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="number-align">
              总价：<%= number_to_currency @order.subtotal, locale: :'zh-CN', precision: 2 %>
            </td>
          </tr>
        </tfoot>
      </table>
    </section>
    <section>
      <h3>订单编号</h3>
      <div><%= @order.order_id %></div>
    </section>
    <% if @order.dinning_table_no.present? %>
    <section>
      <h3>桌号</h3>
      <div><%= @order.dinning_table_no %></div>
    </section>
    <% end %>
    <section>
      <h3>状态</h3>
      <div id="status-text">
        <% if @order.printed? && !params[:type].nil? %>
        已付款
        <% else %>
        <%= order_status @order %>
        <% end %>
      </div>
    </section>
    <%= render partial: "show_address" if @order.type.eql?("TakeoutOrder") %>
    <section>
      <h3>历史</h3>
      <table class="table" style="max-width: 600px">
        <thead>
          <tr>
            <th>时间</th><th>状态</th><th>操作人</th>
          </tr>
        </thead>
        <tbody>
          <% @order.order_histories.each do |hist| %>
            <tr>
              <td><%= display_datetime hist.time %></td>
              <td><%= order_history_status hist %></td>
              <td><%= order_status_change_operator hist %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </section>
    <% if need_online_pay?(@order) || is_cancelable?(@order) %>
      <section>
        <% if need_online_pay? @order %>
          <a class="btn btn-primary btn-block" target="_self" href="<%=@url%>">立即支付</a>
        <% end %>

        <% if is_cancelable? @order %>
          <br>
          <%= link_to "取消订单", :orders_cancel, method: "PUT", class: "btn btn-danger btn-block"%>
        <% end %>
      </section>
    <% end %>
  </div>

</article>
